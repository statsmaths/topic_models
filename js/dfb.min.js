"use strict";var view=function(){var that={},my={updating:false},updating,dirty,loading,calculating,error,warning,tooltip,append_weight_tds,plot_svg,append_svg,scroll_top,scroll_origin;updating=function(flag){if(typeof flag==="boolean"){my.updating=flag}return my.updating};that.updating=updating;dirty=function(key,flag){if(!my.dirty){my.dirty=d3.set()}if(flag===undefined){return my.dirty.has(key)}if(flag){my.dirty.add(key)}else{my.dirty.remove(key)}return flag};that.dirty=dirty;loading=function(flag){d3.select("#working_icon").classed("invisible",!flag)};that.loading=loading;calculating=function(sel,flag){d3.select("#working_icon").classed("invisible",!flag);d3.selectAll(sel+" .calc").classed("hidden",!flag);d3.selectAll(sel+" .calc-done").classed("hidden",flag)};that.calculating=calculating;error=function(msg){d3.select("div#error").classed("hidden",false).append("p").text(msg);this.loading(false);VIS.error=true};that.error=error;warning=function(msg){d3.select("div#warning").classed("hidden",false).append("p").text(msg)};that.warning=warning;tooltip=function(){var tt=my.tooltip;if(tt){return tt}tt={offset:VIS.tooltip.offset};tt.div=d3.select("body").append("div").attr("id","tooltip").classed("bar_tooltip",true);tt.container=d3.select("body").node();tt.div.append("p");tt.update_pos=function(){var mouse_pos=d3.mouse(this.container);this.div.style({left:mouse_pos[0]+this.offset.x+"px",top:mouse_pos[1]+this.offset.y+"px",position:"absolute"})};tt.text=function(text){this.div.select("p").text(text)};tt.show=function(){this.div.classed("hidden",false)};tt.hide=function(){this.div.classed("hidden",true)};my.tooltip=tt;return tt};that.tooltip=tooltip;append_weight_tds=function(sel,f){sel.append("td").classed("weight",true).append("div").classed("proportion",true).style("margin-left",function(w){return d3.format(".1%")(1-f(w))}).append("span").classed("proportion",true).html("&nbsp;")};that.append_weight_tds=append_weight_tds;plot_svg=function(selector,spec){var g;if(!VIS.svg){VIS.svg=d3.map()}if(VIS.svg.has(selector)){g=VIS.svg.get(selector);d3.select(selector+" svg").attr("width",spec.w+spec.m.left+spec.m.right).attr("height",spec.h+spec.m.top+spec.m.bottom);g.attr("transform","translate("+spec.m.left+","+spec.m.top+")")}else{g=append_svg(d3.select(selector),spec);VIS.svg.set(selector,g)}return g};that.plot_svg=plot_svg;append_svg=function(selection,spec){return selection.append("svg").attr("width",spec.w+spec.m.left+spec.m.right).attr("height",spec.h+spec.m.top+spec.m.bottom).append("g").attr("transform","translate("+spec.m.left+","+spec.m.top+")")};that.append_svg=append_svg;scroll_top=function(){window.scrollTo(window.scrollX,0)};that.scroll_top=scroll_top;scroll_origin=function(){window.scrollTo(0,0)};that.scroll_origin=scroll_origin;return that}();"use strict";var bib={};bib.doc_author=function(doc){var lead,lead_trail,result;if(doc.authors.length>0){lead=doc.authors[0].replace(/,/g,"").split(" ");lead_trail=lead.pop();if(lead.length>=2&&lead_trail.search(/^(\d|Jr|Sr|[IXV]+$)/)!==-1){result=lead.pop().replace(/_$/,"");lead_trail=", "+lead_trail.replace(/\W*$/,"")}else{result=lead_trail;lead_trail=""}result+=", "+lead.join(" ")+lead_trail;if(doc.authors.length>1){if(doc.authors.length>2){result+=", ";result+=doc.authors.slice(1,doc.authors.length-1).join(", ")}result+=", and "+doc.authors[doc.authors.length-1]}}else{result="[Anon]"}return result};bib.sort=function(m,major,minor,asc_maj,asc_min){var result=[],docs,major_key,minor_key,cmp_maj,cmp_min,cur_major,i,last,get_id=function(d){return d.id},partition=[];if(major==="decade"){major_key=function(i){return Math.floor(m.meta(i).date.getUTCFullYear()/10).toString()+"0s"}}else if(major==="year"){major_key=function(i){return m.meta(i).date.getUTCFullYear()}}else if(major==="journal"){major_key=function(i){return m.meta(i).journaltitle}}else if(major==="issue"){major_key=function(i){var doc=m.meta(i),k,iss;k=doc.journaltitle;k+="_"+d3.format("05d")(doc.volume);if(String(doc.issue).search("S")!==-1){iss=+doc.issue.replace("S","")*10+5}else{iss=+doc.issue*10}k+="_"+String(iss);return k}}else{major_key=function(i){return bib.doc_author(m.meta(i)).replace(/^\W*/,"")[0].toUpperCase()}}if(minor==="date"){minor_key=function(i){return+m.meta(i).date}}else if(minor==="journal"){minor_key=function(i){var doc=m.meta(i),result_m=doc.journaltitle;result_m+=d3.format("05d")(doc.volume);result_m+=d3.format("05d")(doc.issue===""?0:doc.issue.replace(/\/.*$/,""));if(doc.pagerange.search(/^\d/)!==-1){result_m+=d3.format("05d")(doc.pagerange.match(/^(\d+)/)[1])}else{result_m+=doc.pagerange}return result_m}}else{minor_key=function(i){return bib.doc_author(m.meta(i))+m.meta(i).title}}cmp_maj=asc_maj?d3.ascending:d3.descending;cmp_min=asc_min?d3.ascending:d3.descending;docs=d3.range(m.n_docs()).map(function(d){return{id:d,major:major_key(d),minor:minor_key(d)}}).sort(function(a,b){return cmp_maj(a.major,b.major)||cmp_min(a.minor,b.minor)||d3.ascending(a.id,b.id)});for(i=0,cur_major="";i<docs.length;i+=1){if(docs[i].major!==cur_major){partition.push(i);result.push({heading:docs[i].major});cur_major=docs[i].major}}partition.shift();partition.push(docs.length);for(i=0,last=0;i<partition.length;i+=1){result[i].docs=docs.slice(last,partition[i]).map(get_id);last=partition[i]}return result};bib.sort.validate=function(p){var result=p;if(VIS.bib.keys.major.indexOf(p.major)===-1){result.major=undefined}if(VIS.bib.keys.minor.indexOf(p.minor)===-1){result.minor=undefined}if(p.dir!=="up"&&p.dir!=="down"){result.dir=undefined}return result};bib.sort.dir=function(p){var result={major:true,minor:true};if(p.dir==="up"){return result}if(p.dir==="down"){result.major=false;if(p.major==="decade"||p.major==="year"||p.major==="issue"){result.minor=p.minor!=="date"&&p.minor!=="journal"}else if(p.major==="alpha"||p.major==="journal"){result.minor=p.minor!=="alpha"}else{result.minor=true}}return result};bib.author=function(doc){var lead,lead_trail,result;if(doc.authors.length>0){lead=doc.authors[0].replace(/,/g,"").split(" ");lead_trail=lead.pop();if(lead.length>=2&&lead_trail.search(/^(\d|Jr|Sr|[IXV]+$)/)!==-1){result=lead.pop().replace(/_$/,"");lead_trail=", "+lead_trail.replace(/\W*$/,"")}else{result=lead_trail;lead_trail=""}result+=", "+lead.join(" ")+lead_trail;if(doc.authors.length>1){if(doc.authors.length>2){result+=", ";result+=doc.authors.slice(1,doc.authors.length-1).join(", ")}result+=", and "+doc.authors[doc.authors.length-1]}}else{result="[Anon]"}return result};bib.citation=function(doc){var s=bib.doc_author(doc),title,mo;s=s.replace(/\.?$/,". ");title=doc.title.replace(/“/g,"‘").replace(/”/g,"’").replace(/(^|[-\u2014\/(\[{\u2018\s])"/g,"$1‘").replace(/"/g,"’").replace(/'/g,"’").replace(/ <br><\/br>/g,". ");s+="“"+title+".”";s=s.replace(/’\./g,".’");s+=" <em>"+doc.journaltitle+"</em> ";s+=doc.volume;if(doc.issue){s+=", no. "+doc.issue}s+=" (";mo=doc.date.getUTCMonth();if(mo===0||mo===11){s+="Winter "}else if(mo===2||mo===3){s+="Spring "}else if(mo===5||mo===6){s+="Summer "}else if(mo===8||mo===9){s+="Autumn "}s+=doc.date.getUTCFullYear()+"): ";s+=doc.pagerange+".";s=s.replace(/\.\./g,".");s=s.replace(/_/g,",");s=s.replace(/\t/g,"");return title};bib.parse=function(d){var date=new Date;return{doi:d[0],title:d[1].trim(),authors:"",journaltitle:"",volume:"",issue:"",date:date,pagerange:"",special:""}};"use strict";var bib={};bib.doc_author=function(doc){var lead,lead_trail,result;if(doc.authors.length>0){lead=doc.authors[0].replace(/,/g,"").split(" ");lead_trail=lead.pop();if(lead.length>=2&&lead_trail.search(/^(\d|Jr|Sr|[IXV]+$)/)!==-1){result=lead.pop().replace(/_$/,"");lead_trail=", "+lead_trail.replace(/\W*$/,"")}else{result=lead_trail;lead_trail=""}result+=", "+lead.join(" ")+lead_trail;if(doc.authors.length>1){if(doc.authors.length>2){result+=", ";result+=doc.authors.slice(1,doc.authors.length-1).join(", ")}result+=", and "+doc.authors[doc.authors.length-1]}}else{result="[Anon]"}return result};bib.sort=function(m,major,minor,asc_maj,asc_min){var result=[],docs,major_key,minor_key,cmp_maj,cmp_min,cur_major,i,last,get_id=function(d){return d.id},partition=[];if(major==="decade"){major_key=function(i){return Math.floor(m.meta(i).date.getUTCFullYear()/10).toString()+"0s"}}else if(major==="year"){major_key=function(i){return m.meta(i).date.getUTCFullYear()}}else if(major==="journal"){major_key=function(i){return m.meta(i).journaltitle}}else if(major==="issue"){major_key=function(i){var doc=m.meta(i),k,iss;k=doc.journaltitle;k+="_"+d3.format("05d")(doc.volume);if(String(doc.issue).search("S")!==-1){iss=+doc.issue.replace("S","")*10+5}else{iss=+doc.issue*10}k+="_"+String(iss);return k}}else{major_key=function(i){return bib.doc_author(m.meta(i)).replace(/^\W*/,"")[0].toUpperCase()}}if(minor==="date"){minor_key=function(i){return+m.meta(i).date}}else if(minor==="journal"){minor_key=function(i){var doc=m.meta(i),result_m=doc.journaltitle;result_m+=d3.format("05d")(doc.volume);result_m+=d3.format("05d")(doc.issue===""?0:doc.issue.replace(/\/.*$/,""));if(doc.pagerange.search(/^\d/)!==-1){result_m+=d3.format("05d")(doc.pagerange.match(/^(\d+)/)[1])}else{result_m+=doc.pagerange}return result_m}}else{minor_key=function(i){return bib.doc_author(m.meta(i))+m.meta(i).title}}cmp_maj=asc_maj?d3.ascending:d3.descending;cmp_min=asc_min?d3.ascending:d3.descending;docs=d3.range(m.n_docs()).map(function(d){return{id:d,major:major_key(d),minor:minor_key(d)}}).sort(function(a,b){return cmp_maj(a.major,b.major)||cmp_min(a.minor,b.minor)||d3.ascending(a.id,b.id)});for(i=0,cur_major="";i<docs.length;i+=1){if(docs[i].major!==cur_major){partition.push(i);result.push({heading:docs[i].major});cur_major=docs[i].major}}partition.shift();partition.push(docs.length);for(i=0,last=0;i<partition.length;i+=1){result[i].docs=docs.slice(last,partition[i]).map(get_id);last=partition[i]}return result};bib.sort.validate=function(p){var result=p;if(VIS.bib.keys.major.indexOf(p.major)===-1){result.major=undefined}if(VIS.bib.keys.minor.indexOf(p.minor)===-1){result.minor=undefined}if(p.dir!=="up"&&p.dir!=="down"){result.dir=undefined}return result};bib.sort.dir=function(p){var result={major:true,minor:true};if(p.dir==="up"){return result}if(p.dir==="down"){result.major=false;if(p.major==="decade"||p.major==="year"||p.major==="issue"){result.minor=p.minor!=="date"&&p.minor!=="journal"}else if(p.major==="alpha"||p.major==="journal"){result.minor=p.minor!=="alpha"}else{result.minor=true}}return result};bib.author=function(doc){var lead,lead_trail,result;if(doc.authors.length>0){lead=doc.authors[0].replace(/,/g,"").split(" ");lead_trail=lead.pop();if(lead.length>=2&&lead_trail.search(/^(\d|Jr|Sr|[IXV]+$)/)!==-1){result=lead.pop().replace(/_$/,"");lead_trail=", "+lead_trail.replace(/\W*$/,"")}else{result=lead_trail;lead_trail=""}result+=", "+lead.join(" ")+lead_trail;if(doc.authors.length>1){if(doc.authors.length>2){result+=", ";result+=doc.authors.slice(1,doc.authors.length-1).join(", ")}result+=", and "+doc.authors[doc.authors.length-1]}}else{result="[Anon]"}return result};bib.citation=function(doc){var s=bib.doc_author(doc),title,mo;s=s.replace(/\.?$/,". ");title=doc.title.replace(/“/g,"‘").replace(/”/g,"’").replace(/(^|[-\u2014\/(\[{\u2018\s])"/g,"$1‘").replace(/"/g,"’").replace(/'/g,"’").replace(/ <br><\/br>/g,". ");s+="“"+title+".”";s=s.replace(/’\./g,".’");s+=" <em>"+doc.journaltitle+"</em> ";s+=doc.volume;if(doc.issue){s+=", no. "+doc.issue}s+=" (";mo=doc.date.getUTCMonth();if(mo===0||mo===11){s+="Winter "}else if(mo===2||mo===3){s+="Spring "}else if(mo===5||mo===6){s+="Summer "}else if(mo===8||mo===9){s+="Autumn "}s+=doc.date.getUTCFullYear()+"): ";s+=doc.pagerange+".";s=s.replace(/\.\./g,".");s=s.replace(/_/g,",");s=s.replace(/\t/g,"");return title};bib.parse=function(d){var date=new Date;return{doi:d[0],title:d[1].trim(),authors:"",journaltitle:"",volume:"",issue:"",date:date,pagerange:"",special:""}};"use strict";var model;model=function(spec){var my=spec||{},that={},info,n_docs,has_dt,tw,n,n_top_words,total_tokens,topic_total,alpha,meta,special_issue,vocab,topic_scaled,topic_yearly,valid_year,yearly_total,topic_docs,topic_words,doc_topics,word_topics,year_topics,topic_name,set_dt,set_tw,set_meta,set_topic_scaled;my.ready={};my.worker=new Worker("../../js/worker.min.js");my.worker.fs=d3.map();my.worker.onmessage=function(e){var f=my.worker.fs.get(e.data.what);if(f){f(e.data.result)}};my.worker.callback=function(key,f){my.worker.fs.set(key,f)};info=function(model_meta){if(model_meta){my.info=model_meta;my.issues=d3.map();my.info.issues.forEach(function(iss){my.issues.set(iss[0],{title:iss[1],url:iss[2]})})}return my.info};that.info=info;n_docs=function(){var result;if(my.n_docs!==undefined){result=my.n_docs}else if(my.meta){result=my.meta.length}return result};that.n_docs=n_docs;has_dt=function(){return!!my.ready.dt};that.has_dt=has_dt;tw=function(t,word){if(!my.tw){return undefined}if(t===undefined){return my.tw}if(word===undefined){return my.tw[t]}return my.tw[t].get(word)};that.tw=tw;n=function(){return my.n};that.n=n;n_top_words=function(){if(!this.tw()){return undefined}return my.tw[0].keys().length};that.n_top_words=n_top_words;total_tokens=function(callback){if(!my.total_tokens){my.worker.callback("total_tokens",function(tot){my.total_tokens=tot;callback(tot)});my.worker.postMessage({what:"total_tokens"})}else{callback(my.total_tokens)}};that.total_tokens=total_tokens;topic_total=function(t,callback){var topic=isFinite(t)?t:"all";my.worker.callback("topic_total/"+topic,callback);my.worker.postMessage({what:"topic_total",t:topic})};that.topic_total=topic_total;alpha=function(t){if(!my.alpha){return undefined}return isFinite(t)?my.alpha[t]:my.alpha};that.alpha=alpha;meta=function(d){if(!my.meta){return undefined}if(typeof d==="number"){return my.meta[d]}if(d===undefined){return my.meta}return d.map(function(j){return my.meta[j]})};that.meta=meta;special_issue=function(d){var ds=d,s;if(!my.meta||!my.issues){return undefined}if(typeof d==="number"){s=my.meta[d].special;return s===""?undefined:my.issues.get(s)}if(d===undefined){ds=d3.range(that.n_docs())}return ds.map(function(d){var sp=my.meta[d].special;return sp===""?undefined:my.issues.get(sp)})};that.special_issue=special_issue;valid_year=function(y){if(!my.years){return undefined}return my.years.has(y)};that.valid_year=valid_year;vocab=function(){var result;if(my.vocab){return my.vocab}if(!this.tw()){return undefined}result=d3.set();this.tw().map(function(words){words.keys().map(function(w){result.add(w)})});my.vocab=result.values().sort();return my.vocab};that.vocab=vocab;topic_scaled=function(t){if(!my.topic_scaled){return undefined}if(t===undefined){return my.topic_scaled}return my.topic_scaled[t]};that.topic_scaled=topic_scaled;yearly_total=function(year,callback){var y=year===undefined?"all":year,f=callback;if(y==="all"){f=function(yearly_total){callback(d3.map(yearly_total))}}my.worker.callback("yearly_total/"+y,f);my.worker.postMessage({what:"yearly_total",y:y})};that.yearly_total=yearly_total;topic_yearly=function(t,callback){var topic=t===undefined?"all":t,f;if(topic==="all"){f=function(yearly){callback(yearly.map(d3.map))}}else{f=function(yearly){callback(d3.map(yearly))}}my.worker.callback("topic_yearly/"+topic,f);my.worker.postMessage({what:"topic_yearly",t:topic})};that.topic_yearly=topic_yearly;topic_docs=function(t,n,year,callback){var n_req=n,f=callback;if(year!==undefined){n_req=this.n_docs();f=function(docs){var year_docs=docs.filter(function(d){return that.meta(d.doc).date.getUTCFullYear()===+year});return callback(utils.shorten(year_docs,n))}}my.worker.callback("topic_docs/"+t+"/"+n_req,f);my.worker.postMessage({what:"topic_docs",t:t,n:n_req})};that.topic_docs=topic_docs;doc_topics=function(d,n,callback){my.worker.callback("doc_topics/"+d+"/"+n,callback);my.worker.postMessage({what:"doc_topics",d:d,n:n})};that.doc_topics=doc_topics;topic_words=function(t,n){var n_words=n||this.n_top_words(),words;if(t===undefined){return d3.range(this.n()).map(function(topic){return that.topic_words(topic,n)})}words=this.tw(t).entries();words.sort(function(w1,w2){return d3.descending(w1.value,w2.value)||d3.ascending(w1.key,w2.key)});return utils.shorten(words,n_words,function(ws,i){return ws[i].value}).map(function(w){return{word:w.key,weight:w.value}})};that.topic_words=topic_words;word_topics=function(word,n){var t,row,word_wt,n_topics=n||this.n_top_words(),result=[],calc_rank=function(row){return row.values().reduce(function(acc,cur){return cur>word_wt?acc+1:acc},0)};for(t=0;t<this.n();t+=1){row=this.tw(t);if(row.has(word)){word_wt=row.get(word);result.push({topic:t,rank:calc_rank(row)})}}result.sort(function(a,b){return d3.ascending(a.rank,b.rank)||d3.ascending(a.topic,b.topic)});return utils.shorten(result,n_topics,function(topics,i){return topics[i].rank})};that.word_topics=word_topics;year_topics=function(year,n){var t,series,result=[];for(t=0;t<this.n();t+=1){series=this.topic_yearly(t);result.push({topic:t,weight:series.get(year)||0})}result.sort(function(a,b){return d3.descending(a.weight,b.weight)||d3.ascending(a.topic,b.topic)});return utils.shorten(result,n)};that.year_topics=year_topics;topic_name=function(t){if(my.info.names){return my.info.names[t+1]}return undefined};that.topic_name=topic_name;set_tw=function(tw_s){var parsed;if(typeof tw_s!=="string"){return}parsed=JSON.parse(tw_s);my.alpha=parsed.alpha;my.tw=parsed.tw.map(function(topic){var result=d3.map();topic.words.map(function(w,j){result.set(w,topic.weights[j])});return result});if(!my.n){my.n=my.alpha.length}};that.set_tw=set_tw;set_dt=function(dt_s,callback){if(typeof dt_s!=="string"){callback(false)}my.worker.callback("set_dt",function(result){my.ready.dt=result;callback(result)});my.worker.postMessage({what:"set_dt",dt:JSON.parse(dt_s)})};that.set_dt=set_dt;set_meta=function(meta_s){var s,doc_years=[];if(typeof meta_s!=="string"){return}s=meta_s.replace(/^\n*/,"").replace(/\n*$/,"\n");my.start_date=new Date(1e3,0,1);my.end_date=new Date;my.meta=d3.csv.parseRows(s,function(d,j){var doc=bib.parse(d);my.start_date=doc.date<my.start_date?doc.date:my.start_date;my.end_date=doc.date>my.end_date?doc.date:my.end_date;return doc});my.worker.callback("set_doc_years",function(result){my.ready.doc_years=result});my.worker.postMessage({what:"set_doc_years",doc_years:doc_years});my.years=d3.set(doc_years)};that.set_meta=set_meta;set_topic_scaled=function(ts_s){var s;if(typeof ts_s!=="string"){return}s=ts_s.replace(/^\n*/,"").replace(/\n*$/,"\n");my.topic_scaled=d3.csv.parseRows(s,function(row){return row.map(parseFloat)})};that.set_topic_scaled=set_topic_scaled;return that};"use strict";view.about=function(section){var sec=section||"intro",elem=d3.select("#about_view #about_"+sec);if(elem.empty()){elem=d3.select("#about_intro");sec="intro"}d3.selectAll("#discussion_text > div").classed("hidden",true);elem.classed("hidden",false);elem.node().scrollIntoView();d3.selectAll("#about_contents li").classed("selected",false);d3.select("#about_contents_"+sec).classed("selected",true);d3.selectAll("#nav_about li").classed("active",false);d3.select("#nav_about_"+sec).classed("active",true);return sec};"use strict";view.doc=function(p){var div=d3.select("div#doc_view"),total_tokens=p.total_tokens,topics=p.topics,trs,as_t;d3.select("#doc_view_main").classed("hidden",false);div.select("h2#doc_header").html(bib.citation(p.meta));if(p.special){div.select("#doc_remark .special_issue a").attr("href",p.special.url).text(p.special.title)}div.select("#doc_remark .special_issue").classed("hidden",!p.special);div.select("#doc_remark .token_count").text(p.total_tokens);div.select("#doc_remark a.jstor").attr("href",view.doc.uri(p.meta));trs=div.select("table#doc_topics tbody").selectAll("tr").data(topics);trs.enter().append("tr");trs.exit().remove();trs.selectAll("td").remove();as_t=trs.append("td").append("a").attr("href",function(t){return topic_link(t.topic)}).classed("topic_words",true);as_t.append("span").classed("name",true).text(function(t,j){return view.topic.label({t:t.topic,name:p.names[j]}).title+": "});as_t.append("span").classed("words",true).text(function(t,j){return p.words[j].reduce(function(acc,x){return acc+" "+x.word},"")});trs.on("click",function(t){set_view(topic_hash(t.topic))});view.append_weight_tds(trs,function(t){return t.weight/total_tokens});trs.append("td").classed("td-right",true).text(function(t){return VIS.percent_format(t.weight/total_tokens)});trs.append("td").classed("td-right",true).text(function(t){return t.weight})};view.doc.uri=function(meta){return meta.doi};"use strict";view.model=function(){return true};"use strict";view.model.list=function(p){var trs,divs,token_max,total=d3.sum(p.sums),keys,sorter,sort_choice,sort_dir,years=p.yearly[0].keys();trs=d3.select("#model_view_list table tbody").selectAll("tr");if(!VIS.ready.model_list){trs=trs.data(d3.range(p.yearly.length)).enter().append("tr");trs.on("click",function(t){set_view(topic_hash(t))});trs.classed("hidden_topic",function(t){return p.topic_hidden[t]});trs.append("td").append("a").classed("topic_words",true);trs.selectAll("a.topic_words").append("span").classed("name",true);trs.selectAll("a.topic_words").append("span").classed("words",true);token_max=d3.max(p.sums);view.append_weight_tds(trs,function(t){return p.sums[t]/token_max});trs.append("td").text(function(t){return VIS.percent_format(p.sums[t]/total)});VIS.ready.model_list=true}trs.selectAll("td a.topic_words").attr("href",topic_link);trs.selectAll("td a.topic_words span.name").text(function(t){return view.topic.label({t:t,words:p.words[t],name:p.names[t]}).title+":"});trs.selectAll("td a.topic_words span.words").text(function(t){return p.words[t].reduce(function(acc,x){return acc+" "+x.word},"")});if(!VIS.last.model_list){VIS.last.model_list={}}sort_choice=p.sort||VIS.last.model_list.sort||"name";sort_dir=p.dir||(sort_choice===VIS.last.model_list.sort?VIS.last.model_list.dir:"up")||"up";keys=d3.range(p.yearly.length);if(sort_choice==="frac"){keys=keys.map(function(t){return-p.sums[t]/total})}else if(sort_choice==="year"){keys=p.yearly.map(function(series){var result,max_weight=0;series.forEach(function(year,weight){if(weight>max_weight){result=year;max_weight=weight}});return result})}else{keys=keys.map(function(t){if(p.names[t]){return view.topic.sort_name(p.names[t])}return p.words[t].reduce(function(acc,w){return acc+" "+w.word},"")})}if(sort_dir==="down"){sorter=function(a,b){return d3.descending(keys[a],keys[b])||d3.descending(a,b)}}else{sorter=function(a,b){return d3.ascending(keys[a],keys[b])||d3.ascending(a,b)}}VIS.last.model_list.sort=sort_choice;VIS.last.model_list.dir=sort_dir;trs.sort(sorter).order();d3.selectAll("#model_view_list th.sort").classed("active",function(){return!!this.id.match(sort_choice)}).each(function(){var ref="#/"+this.id.replace(/_(view_)?/g,"/");if(this.id.match(sort_choice)){ref+=sort_dir==="down"?"/up":"/down"}d3.select(this).select("a").attr("href",ref)}).on("click",function(){set_view(d3.select(this).select("a").attr("href").replace(/#/,""))});return true};"use strict";view.topic=function(p){var div=d3.select("div#topic_view"),ttl;ttl=view.topic.label(p);div.select("#topic_header").text(ttl.title);div.select("#topic_subheader").classed("hidden",!ttl.subtitle).select(".topic_subtitle").text(ttl.subtitle||"")};view.topic.remark=function(p){d3.select("#topic_view #topic_remark").text(VIS.percent_format(p.col_sum/p.total_tokens)+" of corpus")};view.topic.words=function(words){var trs_w;if(view.updating()&&!view.dirty("topic/words")){return}trs_w=d3.select("table#topic_words tbody").selectAll("tr").data(words);trs_w.enter().append("tr");trs_w.exit().remove();trs_w.on("click",function(w){set_view("/word/"+w.word)});trs_w.selectAll("td").remove();trs_w.append("td").append("a").attr("href",function(w){return"#/word/"+w.word}).text(function(w){return w.word});view.append_weight_tds(trs_w,function(w){return w.weight/words[0].weight});view.dirty("topic/words",false)};view.topic.docs=function(p){var header_text,trs_d,docs=p.docs;if(p.year!==undefined){header_text=" in "+p.year;d3.select("#topic_year_clear").classed("disabled",false).on("click",function(){d3.select(".selected_year").classed("selected_year",false);view.updating(true);set_view(topic_hash(p.t))}).classed("hidden",false)}else{header_text="";d3.select("#topic_year_clear").classed("disabled",true)}d3.selectAll("#topic_docs span.topic_year").text(header_text);if(docs===undefined||docs.length===0){d3.selectAll("#topic_docs .none").classed("hidden",false);d3.select("#topic_docs table").classed("hidden",true);return true}d3.selectAll("#topic_docs .none").classed("hidden",true);d3.select("#topic_docs table").classed("hidden",false);trs_d=d3.select("#topic_docs tbody").selectAll("tr").data(docs);trs_d.enter().append("tr");trs_d.exit().remove();trs_d.selectAll("td").remove();trs_d.append("td").classed(VIS.special_issue_class,function(d,j){return!!p.specials[j]}).append("a").html(function(d,j){return p.citations[j]});trs_d.on("click",function(d){set_view("/doc/"+d.doc)});view.append_weight_tds(trs_d,function(d){return d.frac});trs_d.append("td").classed("td-right",true).text(function(d){return VIS.percent_format(d.frac)});trs_d.append("td").classed("td-right",true).text(function(d){return d.weight})};view.topic.yearly=function(p){var spec=VIS.topic_view;spec.w=d3.select("#topic_yearly").node().clientWidth||spec.w;spec.w=Math.max(spec.w,VIS.topic_view.w);spec.w-=spec.m.left+spec.m.right;spec.h=Math.floor(spec.w/VIS.topic_view.aspect)-spec.m.top-spec.m.bottom;view.topic.yearly_barplot({t:p.t,yearly:p.yearly,svg:view.plot_svg("div#topic_plot",spec),axes:true,clickable:true,year:p.year,spec:spec})};view.topic.yearly_barplot=function(param){var series=[],scale_x,scale_y,w,w_click,bars,bars_enter,bars_click,axes,tip_text,tx_duration=view.dirty("topic/yearly")?1e3:0,svg=param.svg,spec=param.spec;series=param.yearly.keys().sort().map(function(y){return[new Date(Date.UTC(+y,0,1)),param.yearly.get(y)]});scale_x=d3.time.scale.utc().domain([series[0][0],d3.time.day.utc.offset(series[series.length-1][0],spec.bar_width)]).range([0,spec.w]);w=scale_x(d3.time.day.utc.offset(series[0][0],spec.bar_width))-scale_x(series[0][0]);w_click=scale_x(d3.time.year.utc.offset(series[0][0],1))-scale_x(series[0][0]);scale_y=d3.scale.linear().domain([0,d3.max(series,function(d){return d[1]})]).range([spec.h,0]).nice();if(param.axes){axes=svg.selectAll("g.axis").data(["x","y"]);axes.enter().append("g").classed("axis",true).classed("x",function(v){return v==="x"}).classed("y",function(v){return v==="y"}).attr("transform",function(v){return v==="x"?"translate(0,"+spec.h+")":"translate(-5, 0)"});axes.transition().duration(tx_duration).attr("transform",function(v){return v==="x"?"translate(0,"+spec.h+")":undefined}).each(function(v){var sel=d3.select(this),ax=d3.svg.axis().scale(v==="x"?scale_x:scale_y).orient(v==="x"?"bottom":"left");if(v==="x"){ax=ax.ticks(d3.time.years.utc,spec.ticks)}else{ax=ax.tickSize(-spec.w).outerTickSize(0).tickFormat(VIS.percent_format).tickPadding(w_click/2).ticks(spec.ticks)}sel.call(ax);if(v==="y"){sel.selectAll("g").filter(function(d){return d>0}).classed("minor",true)}})}bars=svg.selectAll("g.topic_proportion").data(series,function(s){return String(s[0].getUTCFullYear())});bars_enter=bars.enter().append("g").classed("topic_proportion",true).attr("transform",function(d){return"translate("+scale_x(d[0])+",0)"});bars.exit().remove();if(param.clickable){bars_enter.append("rect").classed("interact",true);bars_click=bars.select("rect.interact");bars_click.transition().duration(tx_duration).attr("x",-w_click/2).attr("y",0).attr("width",w_click).attr("height",function(d){return spec.h})}bars.classed("selected_year",function(d){return String(d[0].getUTCFullYear())===param.year});bars_enter.append("rect").classed("display",true).style("fill",param.color).style("stroke",param.color);bars.transition().duration(tx_duration).attr("transform",function(d){return"translate("+scale_x(d[0])+",0)"}).select("rect.display").attr("x",-w/2).attr("y",function(d){return scale_y(d[1])}).attr("width",w).attr("height",function(d){return spec.h-scale_y(d[1])});if(param.clickable){bars.on("mouseover",function(d){d3.select(this).classed("hover",true)}).on("mouseout",function(d){d3.select(this).classed("hover",false)});tip_text=function(d){return d[0].getUTCFullYear()};bars_click.on("mouseover",function(d){var g=d3.select(this.parentNode);g.select(".display").classed("hover",true);view.tooltip().text(tip_text(d));view.tooltip().update_pos();view.tooltip().show()}).on("mousemove",function(d){view.tooltip().update_pos()}).on("mouseout",function(d){d3.select(this.parentNode).select(".display").classed("hover",false);view.tooltip().hide()}).on("click",function(d){if(d3.select(this.parentNode).classed("selected_year")){d3.select(this.parentNode).classed("selected_year",false);view.tooltip().text(tip_text(d));view.updating(true);set_view(topic_hash(param.t))}else{d3.selectAll(".selected_year").classed("selected_year",false);d3.select(this.parentNode).classed("selected_year",true);view.tooltip().text(tip_text(d));view.updating(true);set_view(topic_hash(param.t)+"/"+d[0].getUTCFullYear())}})}view.dirty("topic/yearly",false)};view.topic.label=function(p){var result,sub;if(typeof p.name==="string"){sub=p.name.match(/: .*$/);sub=sub?sub[0]:"";sub=sub.replace(/^: /,"");result=p.name.replace(/: .*$/,"")}else{result="Topic "+String(p.t+1)}return{title:result,subtitle:sub}};view.topic.label.verbose=function(p){var ttl=view.topic.label(p),result=ttl.title,i;if(p.words&&p.words.length>0){if(ttl.subtitle){result+=": "+ttl.subtitle}result+=": ";for(i=0;i<p.words.length;i+=1){result+=" "+p.words[i].word}}return result};view.topic.label.words=function(p){var ws=view.topic.label(p).title.split(/\s+/);return ws.map(function(w){return w==="/"?"or":w})};view.topic.sort_name=function(name){return name.replace(/^(the|a|an) /i,"").toLowerCase()};view.topic.dropdown=function(topics){var lis;d3.select("ul#topic_dropdown").selectAll("li.loading_message").remove();lis=d3.select("ul#topic_dropdown").selectAll("li").data(topics,function(t){return t.topic});lis.enter().append("li").append("a").text(function(t){return view.topic.label(t).title}).attr("href",function(t){return topic_link(t.topic)});lis.sort(function(a,b){return d3.ascending(view.topic.sort_name(a.name),view.topic.sort_name(b.name))}).order();lis.classed("hidden_topic",function(t){return t.hidden})};"use strict";view.word=function(p){var div=d3.select("div#word_view"),word=p.word,n=p.n,words,spec,row_height,width,svg,clip,scale_x,scale_y,scale_bar,gs_t,gs_t_enter,gs_t_label,gs_w,gs_w_enter,tx_w;d3.select("form#word_view_form").on("submit",function(){d3.event.preventDefault();var input_word=d3.select("input#word_input").property("value").toLowerCase();set_view("/word/"+input_word)});if(p.word===undefined){return}div.selectAll("#word_view span.word").text(word);div.selectAll("#word_view .none").classed("hidden",p.topics.length!==0);div.select("table#word_topics").classed("hidden",p.topics.length===0);div.select("#word_view_explainer").classed("hidden",p.topics.length===0);words=p.topics.map(function(t,j){var max_weight,ws=p.words[j];return ws.map(function(tw,i){if(i===0){max_weight=tw.weight}return{word:tw.word,weight:tw.weight/max_weight}})});spec={m:VIS.word_view.m};spec.w=d3.select("#view").node().clientWidth||VIS.word_view.w;spec.w-=spec.m.left+spec.m.right;spec.h=VIS.word_view.row_height*(p.topics.length+1);row_height=VIS.word_view.row_height;svg=view.plot_svg("#word_view_main",spec);width=Math.max(spec.w,VIS.word_view.w);scale_x=d3.scale.linear().domain([0,n]).range([0,width]);scale_y=d3.scale.linear().domain([0,Math.max(1,p.topics.length-1)]).range([row_height,row_height*(Math.max(p.topics.length,1)+1)]);scale_bar=d3.scale.linear().domain([0,1]).range([0,row_height/2]);clip=d3.select("#word_view_clip");if(clip.size()===0){clip=d3.select("#word_view svg").append("clipPath").attr("id","word_view_clip");
clip.append("rect")}clip.select("rect").attr("x",-spec.m.left).attr("y",-spec.m.top).attr("width",spec.w+spec.m.left+spec.m.right).attr("height",spec.h+spec.m.top+spec.m.bottom);svg.attr("clip-path","url(#word_view_clip)");gs_t=svg.selectAll("g.topic").data(p.topics,function(t){return t.topic});gs_t.transition().duration(1e3).attr("transform",function(t,i){return"translate(0,"+scale_y(i)+")"});gs_t_enter=gs_t.enter().append("g").classed("topic",true).attr("transform",function(t,i){return"translate(0,"+scale_y(i)+")"}).style("opacity",0);if(!VIS.ready.word||view.updating()){d3.selectAll("g.topic").style("opacity",1)}else{d3.transition().duration(1e3).ease("linear").each("end",function(){d3.selectAll("g.topic").style("opacity",1)})}gs_t.exit().transition().duration(2e3).attr("transform","translate(0,"+row_height*(n+gs_t.exit().size())+")").remove();gs_t_enter.append("rect").classed("interact",true).attr({x:-spec.m.left,y:-row_height,width:spec.m.left,height:row_height}).on("click",function(t){set_view(topic_hash(t.topic))});gs_t_label=gs_t.selectAll("text.topic").data(function(t,j){var ws=view.topic.label.words({t:t.topic,name:p.names[j]});return ws.map(function(w,k){return{word:w,y:-row_height/2-(ws.length/2-k-1)*VIS.word_view.topic_label_leading}})},function(w,j){return w.word+String(j)});gs_t_label.enter().append("text").classed("topic",true);gs_t_label.exit().remove();gs_t_label.attr("x",-VIS.word_view.topic_label_padding).attr("y",function(w){return w.y}).text(function(w){return w.word}).classed("merged_topic_sep",function(w){return w.word==="or"});gs_w=gs_t.selectAll("g.word").data(function(t,i){return words[i]},function(d){return d.word});gs_w_enter=gs_w.enter().append("g").classed("word",true);gs_w_enter.append("text").attr("transform","rotate(-45)");gs_w_enter.append("rect").classed("proportion",true).attr({x:0,y:0}).attr("width",width/(2*n)).attr("height",function(d){return scale_bar(d.weight)});gs_w.selectAll("text").text(function(d){return d.word});gs_w.selectAll("text, rect").on("click",function(d){set_view("/word/"+d.word)}).on("mouseover",function(){d3.select(this.parentNode).classed("hover",true)}).on("mouseout",function(){d3.select(this.parentNode).classed("hover",false)});gs_w.classed("selected_word",function(d){return d.word===word});gs_w_enter.attr("transform",function(d,j){return"translate("+scale_x(j)+",-"+row_height/2+")"}).attr("opacity",VIS.ready.word&&!view.updating()?0:1);tx_w=gs_w.transition().duration(2e3).attr("transform",function(d,j){return"translate("+scale_x(j)+",-"+row_height/2+")"}).attr("opacity",1);tx_w.selectAll("text").attr("x",width/(4*n));tx_w.selectAll("rect").attr("width",width/(2*n)).attr("height",function(d){return scale_bar(d.weight)});gs_w.exit().transition().delay(1e3).remove();VIS.ready.word=true;return true};"use strict";view.bib=function(p){var ordering=p.ordering.map(function(o){var result=o;o.key=o.heading+"_"+p.minor+"_"+p.dir;return result}),lis;d3.selectAll("select#select_bib_sort option").each(function(){this.selected=this.value===p.major+"_"+p.minor});d3.selectAll("select#select_bib_dir option").each(function(){this.selected=this.value===p.dir});d3.select("select#select_bib_sort").on("change",function(){var sorting;d3.selectAll("#select_bib_sort option").each(function(){if(this.selected){sorting=this.value}});set_view("/bib/"+sorting.replace(/_/,"/"))});d3.select("select#select_bib_dir").on("change",function(){var dir;d3.selectAll("#select_bib_dir option").each(function(){if(this.selected){dir=this.value}});set_view("/bib/"+p.major+"/"+p.minor+"/"+dir)});d3.select("a#bib_sort_dir").attr("href","#/bib/"+p.major+"/"+p.minor+"/"+(p.dir==="up"?"down":"up"));d3.select("#bib_headings a.top_link").on("click",function(){d3.event.preventDefault();view.scroll_top()});lis=d3.select("#bib_view #bib_headings ul").selectAll("li").data(ordering,function(o){return o.key});lis.enter().append("li").append("a");lis.exit().remove();VIS.bib.keys.major.forEach(function(k){lis.classed(k,p.major===k)});lis.selectAll("a").attr("href",function(o){return"#"+view.bib.id(o.heading)}).on("click",function(o){d3.event.preventDefault();d3.select("#"+view.bib.id(o.heading)).node().scrollIntoView()}).text(function(o){return p.major==="issue"?view.bib.decode_issue(o.heading,false):o.heading});if(p.major==="issue"){lis.classed(VIS.special_issue_class,function(o){return!!p.specials[o.docs[0]]})}view.bib.render({ordering:ordering,citations:p.citations,specials:p.specials,major:p.major});return true};view.bib.render=function(p){var sections,sec_enter,items;view.loading(true);sections=d3.select("#bib_main").selectAll("div.section").data(p.ordering,function(o){return o.key});sec_enter=sections.enter().append("div").classed("section",true).attr("id",function(o){return view.bib.id(o.heading)});if(p.major==="issue"){sec_enter.append("h2").classed(VIS.special_issue_class,function(o){return!!p.specials[o.docs[0]]}).html(function(o){var s=view.bib.decode_issue(o.heading,true),d=o.docs[0];if(p.specials[d]){s+='. <a href="'+p.specials[d].url+'">';s+=p.specials[d].title;s+="</a>"}return s})}else{sec_enter.append("h2").html(function(o){return o.heading})}sec_enter.append("ul");sections.exit().remove();items=sections.select("ul").selectAll("li").data(function(o){return o.docs});items.enter().append("li");items.exit().remove();items.html(function(d){var s='<a href="#/doc/'+d+'">';s+=p.citations[d];s+="</a>";return s}).classed(VIS.special_issue_class,function(d){return!!p.specials[d]});view.loading("false")};view.bib.id=function(heading){return"bib_"+String(heading).replace(/\W/g,"_")};view.bib.decode_issue=function(code,chicago){var vol,no,splits,result;splits=code.split("_");vol=+splits[1];if(+splits[2]%10===0){no=+splits[2]/10}else{no=(+splits[2]-5)/10;no=String(no)+"S"}if(chicago){result="<em>Signs</em> "+vol;result+=", no. "+no}else{result=String(vol);result+="."+no}return result};"use strict";view.model.yearly=function(p){var spec={},svg,scale_x,scale_y,axis_x,g_axis,area,scale_color,bg,clip,raw,to_plot,paths,labels,render_labels,areas,zoom;spec.m=VIS.model_view.yearly.m;spec.w=d3.select("#model_view_yearly").node().clientWidth||VIS.model_view.yearly.w;spec.w=Math.max(spec.w,VIS.model_view.yearly.w);spec.w-=spec.m.left+spec.m.right;spec.h=Math.floor(spec.w/VIS.model_view.yearly.aspect);spec.h-=spec.m.top+spec.m.bottom;svg=view.plot_svg("#model_view_yearly",spec);raw=p.type?p.type==="raw":VIS.last.model_yearly;VIS.last.model_yearly=raw;to_plot=view.model.yearly.stacked_series({yearly_totals:p.yearly_totals,topics:p.topics,raw:raw});bg=svg.selectAll("rect.bg").data([1]).enter().append("rect").classed("bg",true);bg.attr("width",spec.w).attr("height",spec.h).classed("bg",true);clip=d3.select("#model_yearly_clip");if(clip.size()===0){clip=d3.select("#model_view_yearly svg").append("clipPath").attr("id","model_yearly_clip");clip.append("rect").attr("x",0).attr("y",0).attr("width",spec.w).attr("height",spec.h)}d3.select("#model_yearly_clip rect").transition().duration(2e3).attr("width",spec.w).attr("height",spec.h);scale_color=function(){var cat20=d3.scale.category20(),seq=[];to_plot.order.forEach(function(k,r){seq[k]=r});return function(t,highlight){var c=cat20(seq[t]%20);return highlight?d3.hsl(c).brighter(.5).toString():c}}();scale_x=d3.time.scale.utc().domain(to_plot.domain_x).range([0,spec.w]);scale_y=d3.scale.linear().domain(to_plot.domain_y).range([spec.h,0]).nice();axis_x=d3.svg.axis().scale(scale_x).orient("bottom");g_axis=svg.selectAll("g.axis").data([1]);g_axis.enter().append("g").classed("axis",true).classed("x",true).attr("transform","translate(0,"+spec.h+")");g_axis.transition().duration(2e3).attr("transform","translate(0,"+spec.h+")").call(axis_x);paths=svg.selectAll("path.topic_area").data(to_plot.data);paths.enter().append("path").classed("topic_area",true).attr("clip-path","url(#model_yearly_clip)").style("fill",function(d){return scale_color(d.t)}).on("mouseover",function(d){d3.select(this).style("fill",scale_color(d.t,true));view.tooltip().text(view.topic.label(d).title);view.tooltip().update_pos();view.tooltip().show()}).on("mousemove",function(d){view.tooltip().update_pos()}).on("mouseout",function(d){d3.select(this).style("fill",scale_color(d.t));view.tooltip().hide()}).on("click",function(d){if(!d3.event.shiftKey){set_view(topic_hash(d.t))}});paths.exit().remove();area=d3.svg.area().x(function(d){return scale_x(d.x)}).y0(function(d){return scale_y(d.y0)}).y1(function(d){return scale_y(d.y0+d.y)});areas=function(d){return area(d.values)};paths.transition().duration(2e3).attr("d",areas);labels=svg.selectAll("text.layer_label").data(to_plot.data,function(d){return d.t});labels.enter().append("text").classed("layer_label",true).attr("clip-path","url(#model_yearly_clip)");labels.exit().remove();render_labels=function(sel){var i,j,t,xs,cur,show=[],max=[],x0=scale_x.domain()[0],x1=scale_x.domain()[1],y0=scale_y.domain()[0],y1=scale_y.domain()[1],b=scale_y(0);for(i=0;i<to_plot.data.length;i+=1){t=to_plot.data[i].t;show[t]=false;xs=to_plot.data[i].values;for(j=0,cur=0;j<xs.length;j+=1){if(xs[j].x>=x0&&xs[j].x<=x1&&xs[j].y0+xs[j].y>=y0&&xs[j].y0+xs[j].y<=y1){if(xs[j].y>cur&&b-scale_y(xs[j].y)>VIS.model_view.yearly.label_threshold){show[t]=true;max[t]=j;cur=xs[j].y}}}}sel.attr("display",function(d){return show[d.t]?"inherit":"none"});sel.filter(function(d){return show[d.t]}).attr("x",function(d){return scale_x(d.values[max[d.t]].x)}).attr("y",function(d){return scale_y(d.values[max[d.t]].y0+d.values[max[d.t]].y/2)}).text(function(d){return view.topic.label(d).title})};render_labels(labels.transition().duration(2e3));zoom=d3.behavior.zoom().x(scale_x).y(scale_y).scaleExtent([1,5]).on("zoom",function(){if(VIS.zoom_transition){paths.transition().duration(2e3).attr("d",areas);svg.select("g.x.axis").transition().duration(2e3).call(axis_x);render_labels(labels.transition().duration(2e3));VIS.zoom_transition=false}else{paths.attr("d",areas);render_labels(labels);svg.select("g.x.axis").call(axis_x)}});d3.select("button#reset_zoom").on("click",function(){VIS.zoom_transition=true;zoom.translate([0,0]).scale(1).event(svg)});zoom(svg);d3.select("button#yearly_raw_toggle").text(raw?"Show proportions":"Show counts").on("click",function(){set_view(raw?"/model/yearly/frac":"/model/yearly/raw")});d3.selectAll("#yearly_choice li").classed("active",false);d3.select(raw?"#nav_model_yearly_raw":"#nav_model_yearly_frac").classed("active",true);return true};view.model.yearly.stacked_series=function(p){var year_keys,years,all_series,stack,ord,data_frac,data_raw,stack_domain_y;if(!VIS.model_view.yearly.data){VIS.model_view.yearly.data={};year_keys=p.yearly_totals.keys().sort();years=year_keys.map(function(y){return new Date(Date.UTC(+y,0,1))});VIS.model_view.yearly.domain_years=d3.extent(years);all_series=p.topics.map(function(topic){var series={t:topic.t,words:topic.words,name:topic.name};series.values=year_keys.map(function(yr,j){var result={yr:yr,x:years[j],y:topic.wts.get(yr)||0};return result});return series});stack=d3.layout.stack().values(function(d){return d.values}).offset("wiggle").order("inside-out");data_frac=stack(all_series);ord=stack.order()(all_series.map(function(ds){return ds.values.map(function(d){return[d.x,d.y]})}));stack.order(function(d){return ord});data_raw=stack(all_series.map(function(s){return{t:s.t,words:s.words,name:s.name,values:s.values.map(function(d){return{x:d.x,y:d.y*p.yearly_totals.get(d.yr)}})}}));stack_domain_y=function(xs){return[0,d3.max(xs.map(function(ds){return d3.max(ds.values,function(d){return d.y0+d.y})}))]};VIS.model_view.yearly.domain_frac=stack_domain_y(data_frac);VIS.model_view.yearly.domain_raw=stack_domain_y(data_raw);VIS.model_view.yearly.order=ord;VIS.model_view.yearly.data.frac=data_frac;VIS.model_view.yearly.data.raw=data_raw}return{data:VIS.model_view.yearly.data[p.raw?"raw":"frac"],domain_x:VIS.model_view.yearly.domain_years,domain_y:VIS.model_view.yearly[p.raw?"domain_raw":"domain_frac"],order:VIS.model_view.yearly.order}};"use strict";view.model.plot=function(param){var svg,cloud_size,circle_radius,range_padding,zoom_rect,domain_x,domain_y,scale_x,scale_y,scale_size,scale_stroke,gs,gs_enter,words,translation,zoom,topics=param.topics,n=param.topics.length,spec={};spec.w=d3.select("#model_view").node().clientWidth||VIS.model_view.w;spec.w=Math.max(spec.w,VIS.model_view.w);spec.h=Math.floor(spec.w/VIS.model_view.aspect);spec.m={left:0,right:0,top:0,bottom:0};svg=view.plot_svg("#model_view_plot",spec);circle_radius=Math.floor(spec.w/(2.1*Math.sqrt(VIS.model_view.aspect*n)));cloud_size=circle_radius*1.8;range_padding=1.1*circle_radius;zoom_rect=svg.selectAll("rect.bg").data([1]);zoom_rect.enter().append("rect").classed("bg",true);zoom_rect.attr("width",spec.w);zoom_rect.attr("height",spec.h);if(param.type==="scaled"){topics.forEach(function(p,j){topics[j].x=p.scaled[0];topics[j].y=p.scaled[1]})}else{topics.forEach(function(p,j){topics[j].sort_key=p.name?view.topic.sort_name(p.name):p.words.join(" ")});topics=topics.sort(function(a,b){return d3.ascending(a.sort_key,b.sort_key)});view.model.grid_coords(n,VIS.model_view.cols||Math.floor(Math.sqrt(VIS.model_view.aspect*n))).forEach(function(p,j){topics[j].x=p.x;topics[j].y=p.y})}domain_x=d3.extent(topics,function(d){return d.x});domain_y=d3.extent(topics,function(d){return d.y});scale_x=d3.scale.linear().domain(domain_x).range([range_padding,spec.w-range_padding]);scale_y=d3.scale.linear().domain(domain_y).range([spec.h-range_padding,range_padding]);scale_size=d3.scale.sqrt().domain([0,1]).range(VIS.model_view.size_range);scale_stroke=d3.scale.linear().domain([0,d3.max(topics,function(p){return p.total})]).range([0,VIS.model_view.stroke_range]);gs=svg.selectAll("g").data(topics,function(p){return p.t});gs_enter=gs.enter().append("g");gs.exit().remove();gs_enter.append("clipPath").attr("id",function(p){return"clip_circ"+p.t}).append("circle").attr({cx:0,cy:0});gs_enter.append("circle").attr("cx",0).attr("cy",0).classed("topic_cloud",true).attr("stroke-width",function(p){return scale_stroke(p.total)}).on("click",function(p){if(!d3.event.shiftKey){set_view(topic_hash(p.t))}}).on("mouseover",function(p){gs.sort(function(a,b){if(a.t===b.t){return 0}if(a.t===p.t){return 1}if(b.t===p.t){return-1}return d3.ascending(a.t,b.t)}).order()}).on("mouseout",function(){gs.sort(function(a,b){return d3.ascending(a.t,b.t)}).order()});words=gs.selectAll("text.topic_word").data(function(p){var max_wt=p.words[0].weight,wds=p.words.map(function(w){return{text:w.word,size:Math.floor(scale_size(w.weight/max_wt)),t:p.t}}),up=0,down=0,toggle=false,i;for(i=0;i<wds.length;i+=1,toggle=!toggle){if(toggle){wds[i].y=up;up-=wds[i].size}else{down+=wds[i].size;wds[i].y=down}if(up-cloud_size/2<wds[i].size&&down>cloud_size/2){break}}return wds.slice(0,i)});words.enter().append("text").classed("topic_word",true).attr("clip-path",function(w){return"url(#"+"clip_circ"+w.t}).style("font-size","1px");words.text(function(wd){return wd.text}).attr("x",0).attr("y",function(wd){return wd.y});gs_enter.selectAll("text.topic_name").data(function(p){var ws=view.topic.label.words(p);return ws.map(function(w,j){return{w:w,y:VIS.model_view.name_size*(j-(ws.length-1)/2)}})}).enter().append("text").classed("topic_name",true).attr("x",0).attr("y",function(w){return w.y}).text(function(w){return w.w}).style("font-size",VIS.model_view.name_size+"px").classed("merged_topic_sep",function(w){return w.w==="or"});translation=function(p){var result="translate("+scale_x(p.x);result+=","+scale_y(p.y)+")";return result};gs.transition().duration(1e3).attr("transform",translation).selectAll("circle").attr("r",circle_radius);gs_enter.transition().duration(0).attr("transform",translation).selectAll("circle").attr("r",circle_radius);words.transition().duration(1e3).style("font-size",function(wd){return wd.size+"px"});gs_enter.selectAll("text.topic_word").transition().duration(0).style("font-size",function(wd){return wd.size+"px"});words.exit().transition().duration(1e3).style("font-size","1px").remove();if(param.type==="scaled"){zoom=d3.behavior.zoom().x(scale_x).y(scale_y).scaleExtent([1,10]).on("zoom",function(){if(VIS.zoom_transition){gs.transition().duration(1e3).attr("transform",translation);VIS.zoom_transition=false}else{gs.attr("transform",translation)}});d3.select("button#reset_zoom").on("click",function(){VIS.zoom_transition=true;zoom.translate([0,0]).scale(1).event(svg)});zoom(svg)}else{svg.on(".zoom",null)}};view.model.grid_coords=function(n,cols){var n_col=cols||Math.floor(Math.sqrt(n)),n_row=Math.round(n/n_col),remain=n-n_row*n_col,sgn=d3.ascending(remain,0),rows=[],vskip,i,j,result=[];vskip=Math.sqrt(3)/2;for(i=sgn===1?0:1;i<n_row;i+=2){rows[i]=n_col;if(Math.abs(remain)>0){rows[i]+=sgn;remain-=sgn}}for(i=sgn===1?1:0;i<n_row;i+=2){rows[i]=n_col;if(Math.abs(remain)>0){rows[i]+=sgn;remain-=sgn}}if(sgn===-1){rows.reverse()}if(d3.sum(rows)!==n){view.error("The topic grid has gone wrong. This is a bug.")}for(i=0;i<n_row;i+=1){for(j=0;j<rows[i];j+=1){result.push({x:j+.5+(i%2===0?0:.5),y:(n_row-i)*vskip+.5})}}return result};"use strict";view.settings=function(p){if(VIS.ready.settings){return}d3.select("#n_words_list").property("min",1).property("max",p.max_words).property("value",VIS.overview_words).on("change",function(){VIS.overview_words=this.valueAsNumber});d3.select("#n_words_topic").property("min",1).property("max",p.max_words).property("value",VIS.topic_view.words).on("change",function(){VIS.topic_view.words=this.valueAsNumber});d3.select("#n_topic_docs").property("min",1).property("max",p.max_docs).property("value",VIS.topic_view.docs).on("change",function(){VIS.topic_view.docs=this.valueAsNumber});d3.select("#highlight_special").property("checked",VIS.special_issue_class==="special_issue").on("change",function(){var flag=VIS.special_issue_class==="special_issue";if(flag){VIS.special_issue_class="special_issue_nohighlight";d3.selectAll(".special_issue").classed({special_issue:false,special_issue_nohighlight:true})}else{VIS.special_issue_class="special_issue";d3.selectAll(".special_issue_nohighlight").classed({special_issue:true,special_issue_nohighlight:false})}});d3.select("#reveal_hidden").property("checked",VIS.show_hidden_topics===true).on("change",function(){VIS.show_hidden_topics=!VIS.show_hidden_topics;VIS.model_view.yearly.data=undefined;VIS.ready.model_yearly=false});VIS.ready.settings=true};"use strict";view.words=function(vocab){if(!VIS.ready.words){d3.select("ul#vocab_list").selectAll("li").data(vocab).enter().append("li").append("a").text(function(w){return w}).attr("href",function(w){return"#/word/"+w});VIS.ready.words=true}return true};"use strict";var VIS={ready:{},last:{bib:{}},files:{info:"data/info.json",meta:"data/meta.csv",dt:"data/dt.json",tw:"data/tw.json",topic_scaled:"data/topic_scaled.csv"},default_view:"/model",overview_words:15,model_view:{w:500,aspect:1.3333,words:4,size_range:[7,18],name_size:18,stroke_range:6,yearly:{w:500,aspect:2,m:{left:20,right:20,top:20,bottom:20},label_threshold:40,words:4,label_words:2},list:{spark:{w:70,h:20,m:{left:2,right:2,top:2,bottom:2},bar_width:300}}},topic_view:{words:50,docs:20,w:400,aspect:3,m:{left:40,right:20,top:20,bottom:20},bar_width:90,ticks:10},word_view:{n_min:10,topic_label_padding:8,topic_label_leading:14,row_height:80,svg_rows:10,w:1e3,m:{left:100,right:40,top:20,bottom:0}},bib:{keys:{major:["decade","year","journal","issue","alpha"],minor:["date","journal","alpha"]},author_delimiter:"\t"},bib_view:{window_lines:100,major:"year",minor:"alpha",dir:"up"},float_format:function(x){return d3.round(x,3)},tooltip:{offset:{x:10,y:0}},percent_format:d3.format(".1%"),cite_date_format:d3.time.format.utc("%B %Y"),uri_proxy:"",special_issue_class:"special_issue",getting_started:{exp_interval:30},resize_refresh_delay:100,hidden_topics:[],show_hidden_topics:false,annotes:[]};var topic_link,topic_hash,topic_view,word_view,words_view,doc_view,bib_view,about_view,model_view,model_view_list,model_view_plot,model_view_yearly,set_view,view_refresh,hide_topics,view_loading,settings_modal,setup_vis,load_data,main;topic_link=function(t){return"#"+topic_hash(t)};topic_hash=function(t){return"/topic/"+String(t+1)};topic_view=function(m,t_user,y){var words,year,t=+t_user-1;if(!m.meta()||!m.has_dt()||!m.tw()){view.loading(true);return true}if(!isFinite(t)||t<0||t>=m.n()){d3.select("#topic_view_help").classed("hidden",false);d3.select("#topic_view_main").classed("hidden",true);view.loading(false);return true}year=m.valid_year(y)?y:undefined;words=utils.shorten(m.topic_words(t),VIS.topic_view.words);view.topic({t:t,words:words,name:m.topic_name(t)});d3.select("#topic_view_help").classed("hidden",true);d3.select("#topic_view_main").classed("hidden",false);m.total_tokens(function(total){m.topic_total(t,function(topic_total){view.topic.remark({alpha:m.alpha(t),col_sum:topic_total,total_tokens:total})})});view.topic.words(words);if(VIS.cur_view&&VIS.cur_view.attr("id")==="topic_view"){view.dirty("topic/yearly",true)}if(!view.updating()&&!view.dirty("topic/yearly")){d3.select("#topic_plot").classed("invisible",true)}m.topic_yearly(t,function(yearly){view.topic.yearly({t:t,year:year,yearly:yearly});d3.select("#topic_plot").classed("invisible",false)});view.calculating("#topic_docs",true);m.topic_docs(t,VIS.topic_view.docs,year,function(docs){var ds=docs.map(function(d){return d.doc});view.calculating("#topic_docs",false);view.topic.docs({t:t,docs:docs,specials:m.special_issue(ds),citations:docs.map(function(d){return bib.citation(m.meta(d.doc))}),year:year})});view.loading(false);return true};word_view=function(m,w){var div=d3.select("div#word_view"),word=w,topics,n=0;if(!m.tw()){view.loading(true);return true}view.loading(false);if(word){div.select("#word_view_help").classed("hidden",true)}else{div.select("#word_view_help").classed("hidden",false);if(VIS.last.word){word=VIS.last.word;div.select("a#last_word").attr("href","#/word/"+word).text(document.URL.replace(/#.*$/,"")+"#/word/"+word);div.select("#last_word_help").classed("hidden",false)}else{div.select("#word_view_main").classed("hidden",true);view.word({word:undefined});return true}}div.select("#word_view_main").classed("hidden",false);VIS.last.word=word;topics=m.word_topics(word).filter(function(t){return!VIS.topic_hidden[t.topic]||VIS.show_hidden_topics});if(topics.length>0){n=1+d3.max(topics,function(t){return t.rank});n=d3.max(topics,function(t){return m.topic_words(t.topic,n).length})}n=Math.max(VIS.word_view.n_min,n);view.word({word:word,topics:topics,words:topics.map(function(t){return m.topic_words(t.topic,n).slice(0,n)}),n:n,n_topics:m.n(),names:topics.map(function(t){return m.topic_name(t.topic)})});return true};words_view=function(m){if(!m.tw()){view.loading(true);return true}view.loading(false);return view.words(m.vocab())};doc_view=function(m,d){var div=d3.select("div#doc_view"),doc=+d;if(!m.meta()||!m.has_dt()||!m.tw()){view.loading(true);return true}view.loading(false);if(!isFinite(doc)||doc<0||doc>=m.n_docs()){d3.select("#doc_view_help").classed("hidden",false);if(VIS.last.doc===undefined){d3.select("#doc_view_main").classed("hidden",true);return true}doc=VIS.last.doc;div.select("a#last_doc").attr("href","#/doc/"+doc).text(document.URL.replace(/#.*$/,"")+"#/doc/"+doc);div.select("#last_doc_help").classed("hidden",false)}else{d3.select("#doc_view_help").classed("hidden",true);VIS.last.doc=doc}d3.select("#doc_view_main").classed("hidden",false);view.calculating("#doc_view",true);m.doc_topics(doc,m.n(),function(ts){var topics=ts.filter(function(t){return!VIS.topic_hidden[t.topic]||VIS.show_hidden_topics});view.calculating("#doc_view",false);view.doc({topics:topics,meta:m.meta(doc),special:m.special_issue(doc),total_tokens:d3.sum(topics,function(t){return t.weight}),words:topics.map(function(t){return m.topic_words(t.topic,VIS.overview_words)}),names:topics.map(function(t){return m.topic_name(t.topic)})});hide_topics()});return true};bib_view=function(m,maj,min,dir){var sorting={major:maj,minor:min,dir:dir},asc,ordering;if(!m.meta()){view.loading(true);return true}sorting=bib.sort.validate(sorting);if(sorting.minor===undefined){if(sorting.major===undefined){sorting.minor=VIS.last.bib.minor||VIS.bib_view.minor}else{sorting.minor=VIS.bib_view.minor}}if(sorting.major===undefined){sorting.major=VIS.last.bib.major||VIS.bib_view.major}if(sorting.dir===undefined){sorting.dir=VIS.last.bib.dir||VIS.bib_view.dir}VIS.last.bib=sorting;asc=bib.sort.dir(sorting);ordering=bib.sort(m,sorting.major,sorting.minor,asc.major,asc.minor);if(!VIS.ready.bib){VIS.bib_citations=m.meta().map(bib.citation);VIS.ready.bib=true}view.bib({ordering:ordering,major:sorting.major,minor:sorting.minor,dir:sorting.dir,citations:VIS.bib_citations,specials:m.special_issue()});view.loading(false);VIS.ready.bib=true;return true};about_view=function(m,section){var sec=view.about(section);view.loading(false);d3.select("#about_view").classed("hidden",false);return sec};settings_modal=function(m){var p={max_words:m.n_top_words(),max_docs:m.n_docs()};if(p.max_words===undefined||p.max_docs===undefined){return false}view.settings(p);$("#settings_modal").modal();return true};model_view=function(m,type,p1,p2){var type_chosen=type||VIS.last.model||"grid";if(!m.tw()||!m.topic_scaled()){view.loading(true);return true}d3.selectAll("#nav_model li.active").classed("active",false);d3.select("#nav_model_"+type_chosen).classed("active",true);d3.select("#model_view_plot").classed("hidden",true);d3.select("#model_view_list").classed("hidden",true);d3.select("#model_view_yearly").classed("hidden",true);if(type_chosen==="list"){if(!m.meta()||!m.has_dt()){view.loading(true);return true}model_view_list(m,p1,p2);d3.select("#model_view_list").classed("hidden",false)}else if(type_chosen==="yearly"){if(!m.meta()||!m.has_dt()){view.loading(true);return true}model_view_yearly(m,p1);d3.select("#model_view_yearly").classed("hidden",false)}else{if(!m.topic_scaled()||!m.has_dt()){view.loading(true);return true}if(type_chosen!=="scaled"||m.topic_scaled().length!==m.n()){type_chosen="grid"}model_view_plot(m,type_chosen);d3.select("#model_view_plot").classed("hidden",false)}VIS.last.model=type_chosen;view.loading(false);return type_chosen};model_view_list=function(m,sort,dir){view.calculating("#model_view_list",true);m.topic_total(undefined,function(sums){m.topic_yearly(undefined,function(yearly){view.calculating("#model_view_list",false);view.model.list({yearly:yearly,sums:sums,words:m.topic_words(undefined,VIS.overview_words),sort:sort,dir:dir,names:d3.range(m.n()).map(m.topic_name),topic_hidden:VIS.topic_hidden});hide_topics()})});return true};model_view_plot=function(m,type){m.topic_total(undefined,function(totals){var topics=d3.range(m.n());if(!VIS.show_hidden_topics){topics=topics.filter(function(t){return!VIS.topic_hidden[t]})}view.model.plot({type:type,topics:topics.map(function(t){return{t:t,words:m.topic_words(t,VIS.model_view.words),scaled:m.topic_scaled(t),total:totals[t],name:m.topic_name(t)}})})});return true};model_view_yearly=function(m,type){var p={type:type};if(VIS.ready.model_yearly){view.model.yearly(p);return true}view.calculating("#model_view_yearly",true);m.yearly_total(undefined,function(totals){m.topic_yearly(undefined,function(yearly){p.yearly_totals=totals;p.topics=yearly.map(function(wts,t){return{t:t,wts:wts,words:m.topic_words(t,VIS.model_view.yearly.words),name:m.topic_name(t)}}).filter(function(topic){return VIS.show_hidden_topics||!VIS.topic_hidden[topic.t]});view.model.yearly(p);view.calculating("#model_view_yearly",false)})});return true};set_view=function(hash){window.location.hash=hash};view_refresh=function(m,v){var view_parsed,v_chosen,param,success,j;view_parsed=v.split("/");if(VIS.cur_view!==undefined&&!view.updating()){VIS.cur_view.classed("hidden",true)}if(view_parsed[0]!=="#"){view_parsed=VIS.default_view.split("/")}v_chosen=view_parsed[1];param=view_parsed.slice(2,view_parsed.length);param.unshift(m);switch(v_chosen){case"model":success=model_view.apply(undefined,param);break;case"about":success=about_view.apply(undefined,param);break;case"bib":success=bib_view.apply(undefined,param);break;case"topic":success=topic_view.apply(undefined,param);break;case"word":success=word_view.apply(undefined,param);break;case"doc":success=doc_view.apply(undefined,param);break;case"words":success=words_view.apply(undefined,param);break;case"settings":settings_modal(m);success=false;break;default:success=false;break}if(success){if(typeof success==="string"){param=[undefined].concat(success.split("/"))}VIS.cur_view=d3.select("div#"+v_chosen+"_view");VIS.annotes.forEach(function(c){d3.selectAll(c).classed("hidden",true);d3.selectAll(c+"-vis").classed("invisible",true)});VIS.annotes=[".view_"+v_chosen];for(j=1;j<param.length;j+=1){VIS.annotes[j]=VIS.annotes[j-1]+"_"+param[j]}VIS.annotes.forEach(function(c){d3.selectAll(c).classed("hidden",false);d3.selectAll(c+"-vis").classed("invisible",false)})}else{if(VIS.cur_view===undefined){VIS.cur_view=d3.select("div#model_view");model_view(m)}}if(!view.updating()){view.scroll_top()}view.updating(false);hide_topics();VIS.cur_view.classed("hidden",false);d3.selectAll("#nav_main > li.active").classed("active",false);d3.select("li#nav_"+v_chosen).classed("active",true);d3.selectAll("#nav_main li:not(.active) > .nav").classed("hidden",true);d3.selectAll("#nav_main li.active > .nav").classed("hidden",false)};hide_topics=function(flg){var flag=flg===undefined?!VIS.show_hidden_topics:flg;d3.selectAll(".hidden_topic").classed("hidden",function(){return flag})};setup_vis=function(m){if(m.info()){VIS=utils.deep_replace(VIS,m.info().VIS);d3.selectAll(".model_title").html(m.info().title)}window.onhashchange=function(){view_refresh(m,window.location.hash)};$(window).resize(function(){if(VIS.resize_timer){window.clearTimeout(VIS.resize_timer)}VIS.resize_timer=window.setTimeout(function(){view.updating(true);view.dirty("topic/yearly",true);view_refresh(m,window.location.hash);VIS.resize_timer=undefined},VIS.resize_refresh_delay)});if(document.cookie.indexOf("visited=true")===-1){document.cookie="visited=true; expires="+d3.time.day.offset(new Date,VIS.getting_started.exp_interval).toUTCString();$("#getting_started_modal").modal()}d3.select("#nav_settings a").on("click",function(){d3.event.preventDefault();settings_modal(m)});$("#settings_modal").on("hide.bs.modal",function(){view.updating(true);view_refresh(m,window.location.hash)})};load_data=function(target,callback){var target_base,target_id;if(target===undefined){return callback("target undefined",undefined)}target_base=target.replace(/^.*\//,"");target_id="m__DATA__"+target_base.replace(/\..*$/,"");if(document.getElementById(target_id)){return callback(undefined,document.getElementById(target_id).innerHTML)}if(target.search(/\.zip$/)>0){return d3.xhr(target).responseType("arraybuffer").get(function(error,response){var zip,text;if(response&&response.status===200){zip=new JSZip(response.response);text=zip.file(target_base.replace(/\.zip$/,"")).asText()}return callback(error,text)})}return d3.text(target,function(error,s){return callback(error,s)})};main=function(){load_data(VIS.files.info,function(error,info_s){var m=model();if(typeof info_s==="string"){m.info(JSON.parse(info_s))}else{view.warning("Unable to load model info from "+VIS.files.info)}setup_vis(m);load_data(VIS.files.meta,function(error,meta_s){if(typeof meta_s==="string"){m.set_meta(meta_s);view_refresh(m,window.location.hash)}else{view.error("Unable to load metadata from "+VIS.files.meta)}});load_data(VIS.files.dt,function(error,dt_s){m.set_dt(dt_s,function(result){if(result){view_refresh(m,window.location.hash)}else{view.error("Unable to load document topics from "+VIS.files.dt)}})});load_data(VIS.files.tw,function(error,tw_s){if(typeof tw_s==="string"){m.set_tw(tw_s);VIS.topic_hidden=d3.range(m.n()).map(function(t){return VIS.hidden_topics.indexOf(t+1)!==-1});view.topic.dropdown(d3.range(m.n()).map(function(t){return{topic:t,words:m.topic_words(t,VIS.model_view.words),
name:m.topic_name(t),hidden:VIS.topic_hidden[t]}}));view_refresh(m,window.location.hash)}else{view.error("Unable to load topic words from "+VIS.files.tw)}});load_data(VIS.files.topic_scaled,function(error,s){if(typeof s==="string"){m.set_topic_scaled(s)}else{m.set_topic_scaled("");d3.select("#nav_model_scaled").classed("disabled",true).select("a").attr("href","#/model/scaled")}view_refresh(m,window.location.hash)});view_refresh(m,window.location.hash)})};